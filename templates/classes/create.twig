{% extends "layout.twig" %}

{% block title %}Create New Class - {{ parent() }}{% endblock %}

{% block breadcrumb_current %}Create New Class{% endblock %}

{% block content %}
<div class="entry-header">
    <h1 class="entry-title">
        <i class="bi bi-plus-circle me-2"></i>
        Create New Class
    </h1>
</div>

<div class="entry-content">

    <!-- Classes Capture Form -->
    {% if errors %}
    <div class="alert alert-danger" role="alert">
        <h6 class="alert-heading">Please correct the following errors:</h6>
        <ul class="mb-0">
            {% for field, error in errors %}
                <li>{{ error }}</li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    <form id="classes-form" class="needs-validation ydcoza-compact-form" novalidate method="POST" action="{{ base_path }}/classes/create" enctype="multipart/form-data">
        <!-- Hidden Auto-generated Class ID -->
        <input type="hidden" id="class_id" name="class_id" value="auto-generated">
        <input type="hidden" id="redirect_url" name="redirect_url" value="">

        <!-- ===== Section: Basic Details ===== -->
        <div class="container container-md classes-form ps-0">
            <!-- ===== Section 1: Client & Site Information ===== -->
            <div class="section-header mb-3">
                <h3 class="d-flex align-items-center mb-0">
                    <i class="bi bi-building me-2 text-primary"></i>
                    <span class="badge bg-primary me-2">1</span>
                    Client & Site Information
                </h3>
            </div>
            <div class="form-section bg-light p-4 rounded mb-4">
                <div class="row">
                    <!-- Client Name (ID) -->
                    <div class="col-md-6 mb-3">
                        <div class="form-floating">
                            <select id="client_id" name="client_id" class="form-select" required>
                                <option value="">Select</option>
                                {% for client in form_data.clients %}
                                    <option value="{{ client.id }}" {{ form_values.client_id == client.id ? 'selected' : '' }}>
                                        {{ client.name }}
                                    </option>
                                {% endfor %}
                            </select>
                            <label for="client_id">Client Name (ID) <span class="text-danger">*</span></label>
                            {% if errors.client_id %}
                                <div class="invalid-feedback">{{ errors.client_id }}</div>
                            {% endif %}
                            <div class="valid-feedback">Looks good!</div>
                        </div>
                    </div>

                    <!-- Class/Site Name -->
                    <div class="col-md-6 mb-3">
                        <div class="form-floating">
                            <select id="site_id" name="site_id" class="form-select" required>
                                <option value="">Select Site</option>
                                <!-- Sites will be populated via JavaScript based on client selection -->
                            </select>
                            <label for="site_id">Select Site</label>
                            <div class="invalid-feedback">Please select a site.</div>
                            <div class="valid-feedback">Looks good!</div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-12">
                        <div class="form-floating mb-3">
                            <input type="text" class="form-control" id="class_address_line" name="class_address_line"
                                   placeholder=" " value="{{ form_values.class_address_line|default('') }}">
                            <label for="class_address_line">Class Address</label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ===== Section 2: Class Information ===== -->
            <div class="section-header mb-3">
                <h3 class="d-flex align-items-center mb-0">
                    <i class="bi bi-book me-2 text-primary"></i>
                    <span class="badge bg-primary me-2">2</span>
                    Class Information
                </h3>
            </div>
            <div class="form-section bg-light p-4 rounded mb-4">
                <div class="row">
                    <!-- Class Type -->
                    <div class="col-md-6 mb-3">
                        <div class="form-floating">
                            <select id="class_type" name="class_type" class="form-select" required>
                                <option value="">Select Class Type</option>
                                {% for type in form_data.class_types %}
                                    <option value="{{ type.id }}" {{ form_values.class_type == type.id ? 'selected' : '' }}>
                                        {{ type.name }}
                                    </option>
                                {% endfor %}
                            </select>
                            <label for="class_type">Class Type <span class="text-danger">*</span></label>
                            {% if errors.class_type %}
                                <div class="invalid-feedback">{{ errors.class_type }}</div>
                            {% endif %}
                            <div class="valid-feedback">Looks good!</div>
                        </div>
                    </div>

                    <!-- Class Subject -->
                    <div class="col-md-6 mb-3">
                        <div class="form-floating">
                            <select id="class_subject" name="class_subject" class="form-select" required>
                                <option value="">Select Class Subject</option>
                                <!-- Subjects will be populated via JavaScript based on class type -->
                            </select>
                            <label for="class_subject">Class Subject <span class="text-danger">*</span></label>
                            {% if errors.class_subject %}
                                <div class="invalid-feedback">{{ errors.class_subject }}</div>
                            {% endif %}
                            <div class="valid-feedback">Looks good!</div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <!-- Class Code -->
                    <div class="col-md-6 mb-3">
                        <div class="form-floating">
                            <input type="text" class="form-control" id="class_code" name="class_code"
                                   placeholder=" " value="{{ form_values.class_code|default('') }}" required>
                            <label for="class_code">Class Code <span class="text-danger">*</span></label>
                            {% if errors.class_code %}
                                <div class="invalid-feedback">{{ errors.class_code }}</div>
                            {% endif %}
                            <div class="valid-feedback">Looks good!</div>
                        </div>
                    </div>

                    <!-- Duration (Days) -->
                    <div class="col-md-6 mb-3">
                        <div class="form-floating">
                            <input type="number" class="form-control" id="class_duration" name="class_duration"
                                   placeholder=" " value="{{ form_values.class_duration|default('') }}" required>
                            <label for="class_duration">Duration (Days) <span class="text-danger">*</span></label>
                            {% if errors.class_duration %}
                                <div class="invalid-feedback">{{ errors.class_duration }}</div>
                            {% endif %}
                            <div class="valid-feedback">Looks good!</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ===== Section 3: Schedule Information ===== -->
            <div class="section-header mb-3">
                <h3 class="d-flex align-items-center mb-0">
                    <i class="bi bi-calendar me-2 text-primary"></i>
                    <span class="badge bg-primary me-2">3</span>
                    Schedule Information
                </h3>
            </div>
            <div class="form-section bg-light p-4 rounded mb-4">
                <div class="row">
                    <!-- Start Date -->
                    <div class="col-md-6 mb-3">
                        <div class="form-floating">
                            <input type="date" class="form-control" id="original_start_date" name="original_start_date"
                                   placeholder=" " value="{{ form_values.original_start_date|default('') }}" required>
                            <label for="original_start_date">Start Date <span class="text-danger">*</span></label>
                            {% if errors.original_start_date %}
                                <div class="invalid-feedback">{{ errors.original_start_date }}</div>
                            {% endif %}
                            <div class="valid-feedback">Looks good!</div>
                        </div>
                    </div>

                    <!-- Delivery Date -->
                    <div class="col-md-6 mb-3">
                        <div class="form-floating">
                            <input type="date" class="form-control" id="delivery_date" name="delivery_date"
                                   placeholder=" " value="{{ form_values.delivery_date|default('') }}">
                            <label for="delivery_date">Delivery Date</label>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <!-- QA Visit Dates -->
                    <div class="col-12 mb-3">
                        <div class="form-floating">
                            <input type="text" class="form-control" id="qa_visit_dates" name="qa_visit_dates"
                                   placeholder=" " value="{{ form_values.qa_visit_dates|default('') }}">
                            <label for="qa_visit_dates">QA Visit Dates</label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ===== Section 4: Funding & Exams ===== -->
            <div class="section-header mb-3">
                <h3 class="d-flex align-items-center mb-0">
                    <i class="bi bi-cash-coin me-2 text-primary"></i>
                    <span class="badge bg-primary me-2">4</span>
                    Funding & Exams
                </h3>
            </div>
            <div class="form-section bg-light p-4 rounded mb-4">
                <div class="row">
                    <!-- SETA Funded -->
                    <div class="col-md-6 mb-3">
                        <div class="form-floating">
                            <select id="seta_funded" name="seta_funded" class="form-select">
                                <option value="">Select Option</option>
                                {% for option in form_data.yes_no_options %}
                                    <option value="{{ option.value }}" {{ form_values.seta_funded == option.value ? 'selected' : '' }}>
                                        {{ option.label }}
                                    </option>
                                {% endfor %}
                            </select>
                            <label for="seta_funded">SETA Funded</label>
                        </div>
                    </div>

                    <!-- SETA -->
                    <div class="col-md-6 mb-3">
                        <div class="form-floating">
                            <select id="seta" name="seta" class="form-select">
                                <option value="">Select SETA</option>
                                {% for seta in form_data.setas %}
                                    <option value="{{ seta.id }}" {{ form_values.seta == seta.id ? 'selected' : '' }}>
                                        {{ seta.name }}
                                    </option>
                                {% endfor %}
                            </select>
                            <label for="seta">SETA</label>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <!-- Exam Class -->
                    <div class="col-md-6 mb-3">
                        <div class="form-floating">
                            <select id="exam_class" name="exam_class" class="form-select">
                                <option value="">Select Option</option>
                                {% for option in form_data.yes_no_options %}
                                    <option value="{{ option.value }}" {{ form_values.exam_class == option.value ? 'selected' : '' }}>
                                        {{ option.label }}
                                    </option>
                                {% endfor %}
                            </select>
                            <label for="exam_class">Exam Class</label>
                        </div>
                    </div>

                    <!-- Exam Type -->
                    <div class="col-md-6 mb-3">
                        <div class="form-floating">
                            <select id="exam_type" name="exam_type" class="form-select">
                                <option value="">Select Exam Type</option>
                                {% for type in form_data.exam_types %}
                                    <option value="{{ type }}" {{ form_values.exam_type == type ? 'selected' : '' }}>
                                        {{ type }}
                                    </option>
                                {% endfor %}
                            </select>
                            <label for="exam_type">Exam Type</label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ===== Section 5: Staffing ===== -->
            <div class="section-header mb-3">
                <h3 class="d-flex align-items-center mb-0">
                    <i class="bi bi-people me-2 text-primary"></i>
                    <span class="badge bg-primary me-2">5</span>
                    Staffing
                </h3>
            </div>
            <div class="form-section bg-light p-4 rounded mb-4">
                <div class="row">
                    <!-- Class Agent -->
                    <div class="col-md-6 mb-3">
                        <div class="form-floating">
                            <select id="class_agent" name="class_agent" class="form-select" required>
                                <option value="">Select Agent</option>
                                {% for agent in form_data.agents %}
                                    <option value="{{ agent.id }}" {{ form_values.class_agent == agent.id ? 'selected' : '' }}>
                                        {{ agent.name }}
                                    </option>
                                {% endfor %}
                            </select>
                            <label for="class_agent">Select Agent</label>
                            {% if errors.class_agent %}
                                <div class="invalid-feedback">{{ errors.class_agent }}</div>
                            {% endif %}
                            <div class="valid-feedback">Looks good!</div>
                        </div>
                    </div>

                    <!-- Project Supervisor -->
                    <div class="col-md-6 mb-3">
                        <div class="form-floating">
                            <select id="project_supervisor_id" name="project_supervisor_id" class="form-select" required>
                                <option value="">Select Supervisor</option>
                                {% for supervisor in form_data.supervisors %}
                                    <option value="{{ supervisor.id }}" {{ form_values.project_supervisor_id == supervisor.id ? 'selected' : '' }}>
                                        {{ supervisor.name }}
                                    </option>
                                {% endfor %}
                            </select>
                            <label for="project_supervisor_id">Select Supervisor</label>
                            {% if errors.project_supervisor_id %}
                                <div class="invalid-feedback">{{ errors.project_supervisor_id }}</div>
                            {% endif %}
                            <div class="valid-feedback">Looks good!</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Form Actions -->
            <div class="d-flex justify-content-between align-items-center mt-4">
                <a href="{{ base_path }}/classes" class="btn btn-outline-secondary">
                    <i class="bi bi-x-circle me-1"></i>
                    Cancel
                </a>
                <button type="submit" class="btn btn-primary btn-lg">
                    <i class="bi bi-check-circle me-1"></i>
                    Create Class
                </button>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
// Form data for JavaScript
const formData = {{ form_data|json_encode|raw }};

// Handle client selection to populate sites
document.getElementById('client_id').addEventListener('change', function() {
    const clientId = this.value;
    const siteSelect = document.getElementById('site_id');
    
    // Clear existing options
    siteSelect.innerHTML = '<option value="">Select Site</option>';
    
    if (clientId && formData.sites[clientId]) {
        formData.sites[clientId].forEach(site => {
            const option = document.createElement('option');
            option.value = site.id;
            option.textContent = site.name;
            siteSelect.appendChild(option);
        });
    }
});

// Handle class type selection to populate subjects
document.getElementById('class_type').addEventListener('change', function() {
    const classType = this.value;
    const subjectSelect = document.getElementById('class_subject');
    
    // Clear existing options
    subjectSelect.innerHTML = '<option value="">Select Class Subject</option>';
    
    if (classType && formData.class_subjects[classType]) {
        formData.class_subjects[classType].forEach(subject => {
            const option = document.createElement('option');
            option.value = subject;
            option.textContent = subject;
            subjectSelect.appendChild(option);
        });
    }
});

// Auto-calculate end date based on start date and duration
function calculateEndDate() {
    const startDate = document.getElementById('original_start_date').value;
    const duration = document.getElementById('class_duration').value;
    
    if (startDate && duration) {
        const start = new Date(startDate);
        start.setDate(start.getDate() + parseInt(duration));
        
        // You could display this calculated end date somewhere
        console.log('Calculated end date:', start.toISOString().split('T')[0]);
    }
}

document.getElementById('original_start_date').addEventListener('change', calculateEndDate);
document.getElementById('class_duration').addEventListener('change', calculateEndDate);

// Form validation
(function() {
    'use strict';
    window.addEventListener('load', function() {
        var forms = document.getElementsByClassName('needs-validation');
        var validation = Array.prototype.filter.call(forms, function(form) {
            form.addEventListener('submit', function(event) {
                if (form.checkValidity() === false) {
                    event.preventDefault();
                    event.stopPropagation();
                }
                form.classList.add('was-validated');
            }, false);
        });
    }, false);
})();
</script>
{% endblock %}
